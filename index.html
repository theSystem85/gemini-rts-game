<!DOCTYPE html>
<html>
<head>
<title>Minimal RTS</title>
<style>
body { margin: 0; overflow: hidden; background-color: #333; }
#game-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; }
.tile { width: 32px; height: 32px; box-sizing: border-box; border: 1px solid rgba(0,0,0,0.1); float: left; }
.land { background-color: #8B4513; }
.water { background-color: #0000FF; }
.rock { background-color: #808080; }
.street { background-color: #D3D3D3; }
.ore { background-color: #FFD700; }
.unit { position: absolute; width: 24px; height: 24px; background-color: green; border-radius: 50%; }
.enemy { background-color: red; }
.factory { position: absolute; width: 96px; height: 64px; background-color: gray; }
.enemy-factory { background-color: darkred; }
.health-bar { position: absolute; width: 100%; height: 4px; background-color: red; top: -5px; }
.health { background-color: green; height: 100%; }
.selected { border: 2px solid yellow; }
#ui { position: absolute; top: 10px; left: 10px; color: white; }
#map { position: absolute; }
.bullet{position:absolute;width:4px;height:4px;background-color:black;border-radius:50%;}
</style>
</head>
<body>
<div id="game-container">
    <div id="map"></div>
    <div id="ui">
        Money: <span id="money">1000</span><br>
        <select id="unit-type">
            <option value="tank">Tank (100)</option>
            <option value="harvester">Harvester (500)</option>
        </select>
        <button onclick="produceUnit()">Produce Unit</button><br>
        Production Timer: <span id="production-timer"></span><br>
        <button onclick="startGame()">Start Game</button>
        <button onclick="restartGame()">Restart Game</button>
    </div>
</div>
<script>
const container = document.getElementById('game-container');
const map = document.getElementById('map');
const uiMoney = document.getElementById('money');
const unitTypeSelect = document.getElementById('unit-type');
const productionTimerDisplay = document.getElementById('production-timer');
let money = 1000;
let mapWidth = 50;
let mapHeight = 30;
let tiles = [];
let units = [];
let enemyUnits = [];
let selectedUnit = null;
let isProducing = false;
let productionTime = 0;
let productionInterval;
let enemyFactory;
let playerFactory;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let gameStarted = false;
let occupancyMap = [];
let showOccupancyMap = false;
let bullets = [];

function generateMap() {
    for (let y = 0; y < mapHeight; y++) {
        tiles[y] = [];
        occupancyMap[y] = [];
        for (let x = 0; x < mapWidth; x++) {
            let type = 'land';
            if (Math.random() < 0.2 && (x > 3 && y > 3 && x < mapWidth - 3 && y < mapHeight - 3)) type = 'water';
            if (Math.random() < 0.1 && (x > 3 && y > 3 && x < mapWidth - 3 && y < mapHeight - 3)) type = 'rock';
            if (Math.random() < 0.05 && (x > 3 && y > 3 && x < mapWidth - 3 && y < mapHeight - 3)) type = 'street';
            if (Math.random() < 0.05 && (x > 3 && y > 3 && x < mapWidth - 3 && y < mapHeight - 3)) type = 'ore';
            let tile = document.createElement('div');
            tile.className = 'tile ' + type;
            tile.dataset.x = x;
            tile.dataset.y = y;
            map.appendChild(tile);
            tiles[y][x] = type;
            occupancyMap[y][x] = false;
        }
    }
    map.style.width = (mapWidth * 32) + 'px';
    map.style.height = (mapHeight * 32) + 'px';
}

function createUnit(x, y, isEnemy, type) {
    let unit = document.createElement('div');
    unit.className = 'unit' + (isEnemy ? ' enemy' : '');
    unit.style.left = x * 32 + 'px';
    unit.style.top = y * 32 + 'px';
    unit.dataset.x = x;
    unit.dataset.y = y;
    unit.dataset.health = type === "harvester" ? 300 : 100;
    unit.dataset.type = type;
    let healthBar = document.createElement('div');
    healthBar.className = 'health-bar';
    let health = document.createElement('div');
    health.className = 'health';
    health.style.width = "100%";
    healthBar.appendChild(health);
    unit.appendChild(healthBar);
    map.appendChild(unit);
    if (isEnemy) {
        enemyUnits.push(unit);
    } else {
        units.push(unit);
    }
    return unit;
}

function createFactory(x, y, isEnemy) {
    let factory = document.createElement('div');
    factory.className = 'factory' + (isEnemy ? ' enemy-factory' : '');
    factory.style.left = x * 32 + 'px';
    factory.style.top = y * 32 + 'px';
    factory.dataset.x = x;
    factory.dataset.y = y;
    factory.dataset.health = 500;
    let healthBar = document.createElement('div');
    healthBar.className = 'health-bar';
    let health = document.createElement('div');
    health.className = 'health';
    health.style.width = "100%";
    healthBar.appendChild(health);
    factory.appendChild(healthBar);
    map.appendChild(factory);
    return factory;
}

function produceUnit() {
    if (isProducing) return;
    const unitType = unitTypeSelect.value;
    const cost = unitType === "harvester" ? 500 : 100;
    if (money >= cost) {
        money -= cost;
        uiMoney.textContent = money;
        isProducing = true;
        productionTime = unitType === "harvester" ? 10 : 5; // Adjust production time as needed
        productionTimerDisplay.textContent = productionTime;
        productionInterval = setInterval(() => {
            productionTime--;
            productionTimerDisplay.textContent = productionTime;
            if (productionTime <= 0) {
                clearInterval(productionInterval);
                isProducing = false;
                createUnit(parseInt(playerFactory.dataset.x) + 1, parseInt(playerFactory.dataset.y), false, unitType);
            }
        }, 1000);
    }
}

function gameLoop() {
    if (!gameStarted) return;
    // Enemy AI
    enemyUnits.forEach(enemy => {
        // Basic AI: Move towards player factory
        let fx = parseInt(playerFactory.dataset.x);
        let fy = parseInt(playerFactory.dataset.y);
        let ex = parseInt(enemy.dataset.x);
        let ey = parseInt(enemy.dataset.y);

        if (Math.abs(fx - ex) > Math.abs(fy - ey)) {
            if (fx > ex) {
                moveUnit(enemy, ex + 1, ey);
            } else {
                moveUnit(enemy, ex - 1, ey);
            }
        } else {
            if (fy > ey) {
                moveUnit(enemy, ex, ey + 1);
              } else {
                moveUnit(enemy, ex, ey - 1);
            }
        }

        // Attack logic (simple proximity)
        units.forEach(playerUnit => {
            let px = parseInt(playerUnit.dataset.x);
            let py = parseInt(playerUnit.dataset.y);
            if (Math.abs(px - ex) <= 1 && Math.abs(py - ey) <= 1) {
                attack(enemy, playerUnit);
            }
        });
        if (Math.abs(parseInt(playerFactory.dataset.x) - ex) <= 2 && Math.abs(parseInt(playerFactory.dataset.y) - ey) <= 1) {
            attack(enemy, playerFactory);
        }

    });

    requestAnimationFrame(gameLoop);
}

function moveUnit(unit, x, y) {
    let oldX = parseInt(unit.dataset.x);
    let oldY = parseInt(unit.dataset.y);
    if (x >= 0 && x < mapWidth && y >= 0 && y < mapHeight && tiles[y][x] !== "rock" && tiles[y][x] !== "water" && !occupancyMap[y][x]) {
        occupancyMap[oldY][oldX] = false;
        unit.style.left = x * 32 + 'px';
        unit.style.top = y * 32 + 'px';
        unit.dataset.x = x;
        unit.dataset.y = y;
        occupancyMap[y][x] = unit;
    }
}

function attack(attacker, target) {
    let damage = 10;
    if(attacker.dataset.type === "harvester") damage = 5;
    target.dataset.health -= damage;
    target.querySelector(".health").style.width = (target.dataset.health / (target.className.includes("factory") ? 500 : target.dataset.type === "harvester" ? 300 : 100)) * 100 + "%";
    if (target.dataset.health <= 0) {
        if (target.className.includes("factory")) {
            if (target.className.includes("enemy")) {
                alert("You win!");
                gameStarted = false;
            } else {
                alert("You Lose!");
                gameStarted = false;
            }
        }
        map.removeChild(target);
        if (target.className.includes("enemy")) {
            enemyUnits.splice(enemyUnits.indexOf(target), 1);
        } else {
            units.splice(units.indexOf(target), 1);
        }
    }
}

function startGame() {
    if (gameStarted) return;
    generateMap();
    playerFactory = createFactory(2, 2, false);
    enemyFactory = createFactory(mapWidth-5, mapHeight-3, true);
    createUnit(mapWidth-6, mapHeight-3, true, "tank");
    gameStarted = true;
    gameLoop();
}

function restartGame() {
    map.innerHTML = "";
    units = [];
    enemyUnits = [];
    money = 1000;
    uiMoney.textContent = money;
    gameStarted = false;
    clearInterval(productionInterval);
    isProducing = false;
    productionTimerDisplay.textContent = "";
    startGame();
}

map.addEventListener('mousedown', (e) => {
    if (e.button === 2) { // Right mouse button
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
    }
});

map.addEventListener('mousemove', (e) => {
    if (isDragging) {
        let dx = e.clientX - dragStartX;
        let dy = e.clientY - dragStartY;
        map.style.left = (parseInt(map.style.left || 0) + dx) + 'px';
        map.style.top = (parseInt(map.style.top || 0) + dy) + 'px';
        dragStartX = e.clientX;
        dragStartY = e.clientY;
    }
});

window.addEventListener('mouseup', () => {
    isDragging = false;
});

map.addEventListener('click', (e) => {
    if (e.target.className.includes('unit') && !e.target.className.includes('enemy')) {
        if (selectedUnit) {
            selectedUnit.classList.remove('selected');
        }
        selectedUnit = e.target;
        selectedUnit.classList.add('selected');
    } else if (selectedUnit && gameStarted) {
        let tile = e.target.closest('.tile');
        if (tile) {
            moveUnit(selectedUnit, parseInt(tile.dataset.x), parseInt(tile.dataset.y));
        }
    }
});

document.addEventListener('keydown', (event) => {
    if (event.key === 'o') {
        showOccupancyMap = !showOccupancyMap;
        if(showOccupancyMap){
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    if(occupancyMap[y][x]){
                        let tile = map.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
                        tile.style.backgroundColor = "rgba(255, 255, 0, 0.5)";
                    }
                }
            }
        } else {
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                        let tile = map.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
                        if(tile){
                            tile.style.backgroundColor = "";
                        }
                }
            }
        }
    }
    if(event.key === 'h'){
        alert("Controls:\n- Right Click + Drag: Move Map\n- Click Unit: Select Unit\n- Click Tile: Move Selected Unit\n- o: Toggle Occupancy Map");
    }
});

</script>

</body>
</html>